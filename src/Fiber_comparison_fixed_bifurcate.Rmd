---
title: "Fiber_Comparison"
author: "Jacob T. Nearing Ph.D."
date: "2023-09-14"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(vegan)
library(stringr)
library(ggvenn)
library(kableExtra)
library(ggplot2)
library(reshape2)
library(cowplot)
library(vegan)
library(treeio)
library(plotly)

source("~/Repos/parathaa/parathaa/src/Diagnositc_functions.R")
```

Load in Parathaa kSGB_table
```{r}
parathaa_ksgb_assignments <- read.table("~/Repos/Parathaa2_OP3/m4_kSGB_V3V4/Fiber/taxonomic_assignments.tsv", header=T, sep="\t")

parathaa_abundance_table <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/feature-table.tsv", header=T, sep="\t", skip=1, quote="", comment.char="")

colnames(parathaa_abundance_table)[1] <- "query.name"

parathaa_abundance_table[,-1] <- sweep(parathaa_abundance_table[,-1], 2, colSums(parathaa_abundance_table[,-1]), '/')*100

parathaa_abundance_table_kSGB <- full_join(parathaa_ksgb_assignments, parathaa_abundance_table, by="query.name")

#remove control samples
parathaa_abundance_table_kSGB <- parathaa_abundance_table_kSGB[,-c(256:263, 10)]
```

Load in MetaPhlAn4 table
```{r}
m4_assignments <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/metaphlan_taxonomic_profiles.tsv", sep="\t", quote="", comment.char = "", header=T)

colnames(m4_assignments) <- gsub("_.*", "", colnames(m4_assignments))

indexs <- match(colnames(parathaa_abundance_table), colnames(m4_assignments))
##ignore NAs for the moment..

indexs <- indexs[!is.na(indexs)]


m4_filt <- m4_assignments[,c(1,indexs)]
m4_filt <- m4_filt[-which(rowSums(m4_filt[,-1])==0),]

spec_index <- grep("s__", m4_filt$X..taxonomy)

SGB_index <- grep("t__", m4_filt$X..taxonomy)
only_spec <- setdiff(spec_index, SGB_index)


m4_filt$Species <- gsub(".*s__", "", m4_filt$X..taxonomy)
m4_filt$Species <- gsub("\\|.*", "", m4_filt$Species)

m4_filt$Genus <- gsub(".*g__", "", m4_filt$X..taxonomy)
m4_filt$Genus <- gsub("\\|.*", "", m4_filt$Genus)

m4_filt$Family <- gsub(".*f__", "", m4_filt$X..taxonomy)
m4_filt$Family <- gsub("\\|.*", "", m4_filt$Family)

m4_filt$Order <- gsub(".*o__", "", m4_filt$X..taxonomy)
m4_filt$Order <- gsub("\\|.*", "", m4_filt$Order)

m4_filt$Class <- gsub(".*c__", "", m4_filt$X..taxonomy)
m4_filt$Class <- gsub("\\|.*", "", m4_filt$Class)

m4_filt$Phylum <- gsub(".*p__", "", m4_filt$X..taxonomy)
m4_filt$Phylum <- gsub("\\|.*", "", m4_filt$Phylum)

m4_filt_spec <- m4_filt[c(3,only_spec),]
```

Load in Parathaa_SILVA.SEED
```{r}
parathaa_seed_assignments <- read.table("~/Repos/Parathaa2_OP3/SILVA_run_V3V4/Fiber/taxonomic_assignments.tsv", header=T, sep="\t")

parathaa_abundance_table_seed <- full_join(parathaa_seed_assignments, parathaa_abundance_table, by="query.name")

parathaa_abundance_table_seed <- parathaa_abundance_table_seed[,-c(1, 256:263)]
```

Load in Dada2 assignments
```{r}
DADA2_assignments <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/dada2_assignments.tsv", sep="\t", header=T)
colnames(DADA2_assignments)[8] <- "query.name"

dada2_abundance_table <- full_join(DADA2_assignments, parathaa_abundance_table, by="query.name")
dada2_abundance_table <- dada2_abundance_table[,-c(1, 256:263)]
```

Load in Dada2 seed assignments
```{r}
DADA2_assignments_seed <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/dada2_assignments_seed.tsv", sep="\t", header=T)

colnames(DADA2_assignments_seed)[8] <- "query.name"
dada2_seed_abundance_table <- full_join(DADA2_assignments_seed, parathaa_abundance_table, by="query.name")
dada2_seed_abundance_table <- dada2_seed_abundance_table[,-c(1,256:263)]
```

Load in Parathaa_OG_pipe
```{r}
Parathaa_assignments_OG <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/taxonomic_assignments.tsv", sep="\t", header=T)

parathaa_abundance_table_OG <- full_join(Parathaa_assignments_OG, parathaa_abundance_table, by="query.name")

parathaa_abundance_table_OG <- parathaa_abundance_table_OG[,-c(1, 256:263)]

```


# Number of assignments {.tabset}

Functions
```{r}
tax_levels <- c("Species", "Genus", "Family", "Order", "Class", "Phylum")
calculate_assignments <- function(tax_assignments){
  
  ret_frame <- data.frame(matrix(nrow=12, ncol=1))
  multi_names <- paste("multi", tax_levels, sep=" ")
  rownames(ret_frame) <- c(tax_levels, multi_names)
  colnames(ret_frame) <- "Number of Assignments"  
  
  
  for(i in 1:length(tax_levels)){
    ret_frame[tax_levels[i],1] <- length(which(!is.na(tax_assignments[,tax_levels[i]])))
    ret_frame[multi_names[i],1] <- length(which(grepl(";", tax_assignments[,tax_levels[i]])))
  }
  return(ret_frame)
}
```

## Parathaa kSGB
```{r}
Assignment_levels_kSGB <- calculate_assignments(parathaa_ksgb_assignments)
kable_styling(kable((Assignment_levels_kSGB)))
```

## Parathaa SEED
```{r}
Assignment_levels_SEED <- calculate_assignments(parathaa_seed_assignments)
kable_styling(kable(Assignment_levels_SEED))
```

## Parathaa OG
```{r}
Assignment_levels_OG <- calculate_assignments(Parathaa_assignments_OG)
kable_styling(kable(Assignment_levels_OG))
```

## Dada2
```{r}
Assignment_levels_DADA2 <- calculate_assignments(DADA2_assignments)
kable_styling(kable(Assignment_levels_DADA2))
```

## Dada2_seed
```{r}
Assignment_levels_DADA2_seed <- calculate_assignments(DADA2_assignments_seed)
kable_styling(kable(Assignment_levels_DADA2_seed))
```

Yikes these are a bit concerning...

## Combined table
```{r}
colnames(Assignment_levels_kSGB) <- "# of Assign. kSGB"
colnames(Assignment_levels_SEED) <- "# of Assign. SEED"
colnames(Assignment_levels_DADA2) <- "# of Assign. DADA2"
colnames(Assignment_levels_DADA2_seed) <- "# of Assign. DADA2.Seed"
colnames(Assignment_levels_OG) <- "# of Assign. OG"

merged_assignments <- cbind(Assignment_levels_kSGB, Assignment_levels_SEED, 
                            Assignment_levels_OG, Assignment_levels_DADA2,
                            Assignment_levels_DADA2_seed)
kable_styling(kable(merged_assignments))
```

# Set Analysis

```{r}
m4_genera <- unique(m4_filt_spec$Genus)
parathaa_kSGB_genera <- unique(parathaa_ksgb_assignments$Genus)

genera_set <- list("MetaPhlAn4"=m4_genera, "Parathaa kSGB"=parathaa_kSGB_genera)
ggvenn(genera_set)

## and its probably better than that really...

m4_specs <- unique(m4_filt_spec$Species)
parathaa_kSGB_spec <- unique(parathaa_ksgb_assignments$Species)

spec_set <- list("MetaPhlAn4"=m4_specs, "Parathaa kSGB"=parathaa_kSGB_spec)
ggvenn(spec_set)
### still need to deal with the multi assignments lets try that

parathaa_kSGB_genera_multi <- unlist(str_split(parathaa_kSGB_genera, ";"))
parathaa_kSGB_genera_multi

parathaa_kSGB_spec_multi <- unlist(str_split(parathaa_kSGB_spec, ";"))

genera_set <- list("MetaPhlAn4"=m4_genera, "Parathaa kSGB"=parathaa_kSGB_genera_multi)
ggvenn(genera_set)

spec_set <- list("MetaPhlAn4"=m4_specs, "Parathaa kSGB"=parathaa_kSGB_spec_multi)
ggvenn(spec_set)
```

# Composition Analysis

```{r}
generate_tax_level_table <- function(table, level, prop=1){
  res_list <- list()
  Other <- c()
  for(i in unique(table[,level])){
    tmp_df <- table[which(table[,level]==i),]
    tmp_df <- tmp_df %>% select_if(is.numeric)
    
    tmp <- colSums(tmp_df)
    if(mean(tmp) < prop){
      if(length(Other)==0){
        Other <- tmp
      }else{
      Other <- Other + tmp 
      }
    }else
      res_list[[i]] <- tmp
  }
  res_list[["Other"]] <- Other
  res_df <- data.frame(do.call(rbind, res_list))
  if("maxDist" %in% colnames(res_df)){
      res_df <- res_df[,-which(colnames(res_df) == "maxDist")]
  }
  res_df$Taxon <- rownames(res_df)
  return(res_df)
}
```

## Phylum {.tabset}
```{r}
parathaa_kSGB_Phylum <- generate_tax_level_table(parathaa_abundance_table_kSGB, "Phylum")
parathaa_seed_Phylum <- generate_tax_level_table(parathaa_abundance_table_seed, "Phylum")
parathaa_OG_Phylum <- generate_tax_level_table(parathaa_abundance_table_OG, "Phylum")

dada2_full_Phylum <- generate_tax_level_table(dada2_abundance_table, "Phylum")
dada2_seed_Phylum <- generate_tax_level_table(dada2_seed_abundance_table, "Phylum")

m4_Phylum <- generate_tax_level_table(m4_filt_spec, "Phylum")

unique(c(parathaa_kSGB_Phylum$Taxon, parathaa_seed_Phylum$Taxon, dada2_full_Phylum$Taxon,
       dada2_seed_Phylum$Taxon, m4_Phylum$Taxon, parathaa_OG_Phylum$Taxon))

parathaa_kSGB_Phylum_melt <- melt(parathaa_kSGB_Phylum)
parathaa_seed_Phylum_melt <- melt(parathaa_seed_Phylum)
dada2_full_Phylum_melt <- melt(dada2_full_Phylum)
dada2_seed_Phylum_melt <- melt(dada2_seed_Phylum)
parathaa_OG_Phylum_melt <- melt(parathaa_OG_Phylum)

m4_Phylum_melt <- melt(m4_Phylum)

Phyla_colors <- c('Actinobacteria'="#c56445", "Bacteroidetes"="#9764c9", 'Firmicutes'="#aca535", 
                  'Other'="#6d96ca", "Proteobacteria"="#659f60", "UNCLASSIFIED"="#c65c8a",
                  'Actinobacteriota'="#c56445", 'Bacteroidota'="#9764c9", "Fusobacteriota"="cyan",
                  "Fusobacteria"="cyan", "Firmicutes;Tenericutes"="brown")
```

### Parathaa kSGB
```{r}
parathaa_kSGB_phyla_plot <- parathaa_kSGB_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

parathaa_kSGB_phyla_plot
```

### Parathaa SEED
```{r}
parathaa_seed_phyla_plot <- parathaa_seed_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

parathaa_seed_phyla_plot
```

### Parathaa OG
```{r}
parathaa_OG_phyla_plot <- parathaa_OG_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

parathaa_OG_phyla_plot
```

### Dada2 Full
```{r}
dada2_full_phyla_plot <- dada2_full_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

dada2_full_phyla_plot
```

### Dada2 SEED
```{r}
dada2_seed_phyla_plot <- dada2_seed_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

dada2_seed_phyla_plot
```

### MetaPhlAn4
```{r}
m4_Phyla_plot <- m4_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

m4_Phyla_plot
```

### Combined
```{r}
plot_grid(parathaa_kSGB_phyla_plot +xlab("Parathaa_kSGB") + ylab(""),
          parathaa_seed_phyla_plot + xlab("Parathaa_SEED") + ylab(""),
          #parathaa_OG_phyla_plot + xlab("Parathaa_OG") + ylab(""),
          dada2_full_phyla_plot + xlab("DADA2_full") + ylab(""),
          dada2_seed_phyla_plot + xlab("DADA2_SEED") +ylab(""),
          m4_Phyla_plot + xlab("MetaPhlAn4") + ylab(""),
          ncol=1)
```

## Genus Comparison
```{r}
parathaa_kSGB_Genus <- generate_tax_level_table(parathaa_abundance_table_kSGB, "Genus", prop=5)
parathaa_seed_Genus <- generate_tax_level_table(parathaa_abundance_table_seed, "Genus", prop=5)
parathaa_OG_Genus <- generate_tax_level_table(parathaa_abundance_table_OG, "Genus", prop=5)

dada2_full_Genus <- generate_tax_level_table(dada2_abundance_table, "Genus", prop=5)
dada2_seed_Genus <- generate_tax_level_table(dada2_seed_abundance_table, "Genus", prop=5)

m4_genus <- generate_tax_level_table(m4_filt_spec, "Genus", prop=5)

unique(c(parathaa_kSGB_Genus$Taxon, parathaa_seed_Genus$Taxon, dada2_full_Genus$Taxon, dada2_seed_Genus$Taxon, m4_genus$Taxon))

parathaa_kSGB_Genus_melt <- melt(parathaa_kSGB_Genus)
parathaa_seed_Genus_melt <- melt(parathaa_seed_Genus)
parathaa_OG_Genus_melt <- melt(parathaa_OG_Genus)

dada2_full_Genus_melt <- melt(dada2_full_Genus)
dada2_seed_Genus_melt <- melt(dada2_seed_Genus)

m4_genus_melt <- melt(m4_genus)

Genera_colors_5 <- c("Paraclostridium;Terrisporobacter"="#a2b148",
                     "Firmicutes_unclassified"="#a756c3",
                     "Other"="grey",
                     "Bacillus"="#5bb94e",
                     "Paraclostridium"="#6b6dc6",
                     "Peptoclostridium"="#d39a3b",
                     "Turicibacter"="#6999d4",
                     "Romboutsia"="#ca542a",
                     "Blautia"="#54c0a9",
                     "Bifidobacterium"="#d3425f",
                     "GGB51725"="#49874d",
                     "GGB47957"="#da73b6",
                     "GGB77090"="#83732f",
                     "Terrisporobacter"="#a34d72",
                     "Collinsella"="#cc7d62")

```

### Parathaa kSGB
```{r}
parathaa_kSGB_genus_plot <- parathaa_kSGB_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

parathaa_kSGB_genus_plot
```

### Parathaa SEED
```{r}
parathaa_seed_genus_plot <- parathaa_seed_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

parathaa_seed_genus_plot
```

### Parathaa OG
```{r}
parathaa_OG_genus_plot <- parathaa_OG_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

parathaa_OG_genus_plot
```

### dada2 full
```{r}
dada2_full_Genus_plot <- dada2_full_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

dada2_full_Genus_plot
```

### dada2 SEED
```{r}
dada2_seed_genus_plot <- dada2_seed_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

dada2_seed_genus_plot
```

### MetaPhlAn4

```{r}
m4_genus_plot <- m4_genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

m4_genus_plot
```


### Combined
```{r}
plot_grid(parathaa_kSGB_genus_plot + ylab("") + xlab("Parathaa kSGB"),
          parathaa_seed_genus_plot + ylab("") + xlab("Parathaa SEED"),
          #parathaa_OG_genus_plot + ylab("") + xlab("Parathaa OG"),
          dada2_full_Genus_plot + ylab("") + xlab("Dada2 Full"),
          dada2_seed_genus_plot + ylab("") + xlab("Dada2 Seed"),
          m4_genus_plot + ylab("") + xlab("MetaPhlAn4"),
          ncol=1)
```


## PCA Analysis

```{r}
#takes in a list of feature tables
#takes in a distance type
#generates PCA 
#its not the perfect analysis since B/C doesn't do well with multi-assignments..

generate_PCA <- function(feat_tables, distance="bray"){
  merged_data <- Reduce(function(x, y) merge(x, y, by="Taxon", all=T), feat_tables)
  rownames(merged_data) <- merged_data$Taxon
  merged_data <- merged_data[,-1]
  merged_data[is.na(merged_data)] <- 0
  
  merged_data <- data.frame(t(merged_data))
  
  merged_dist <- vegdist(merged_data, method=distance)
  merged_PCA <- cmdscale(merged_dist, k=2, eig=T)
  
  plot_df <- data.frame(sample=rownames(merged_PCA$points),
                      PC1=merged_PCA$points[,1],
                      PC2=merged_PCA$points[,2])
  plot_df <- plot_df %>% mutate(Method = case_when(
    grepl("P_kSGB_", sample) ~ 'Parathaa_kSGB',
    grepl("P_SEED_", sample) ~ 'Parathaa_SEED',
    grepl("D_Full_", sample) ~ 'Dada2_Full',
    grepl("D_SEED_", sample) ~ 'Dada2_SEED',
    grepl("M4_", sample) ~ 'MetaPhlAn4'
  ))
  
  ret_plot <- plot_df %>% ggplot(aes(x=PC1, y=PC2, colour=Method)) + geom_point() +
    theme_classic(base_size=16)
  return(ret_plot)
}
```

Generate data
```{r}
parathaa_kSGB_Species <- generate_tax_level_table(parathaa_abundance_table_kSGB, level="Genus", prop=0)
colnames(parathaa_kSGB_Species)[-ncol(parathaa_kSGB_Species)] <- 
  paste("P_kSGB_", colnames(parathaa_kSGB_Species)[-ncol(parathaa_kSGB_Species)], sep="")

parathaa_seed_Species <- generate_tax_level_table(parathaa_abundance_table_seed, level="Species", prop=0)
colnames(parathaa_seed_Species)[-ncol(parathaa_seed_Species)] <- 
  paste("P_SEED_", colnames(parathaa_seed_Species)[-ncol(parathaa_seed_Species)], sep="")


dada2_full_Species <- generate_tax_level_table(dada2_abundance_table, level="Species", prop=0)
colnames(dada2_full_Species)[-ncol(dada2_full_Species)] <- 
  paste("D_Full_", colnames(dada2_full_Species)[-ncol(dada2_full_Species)], sep="")

dada2_seed_Species <- generate_tax_level_table(dada2_seed_abundance_table, level="Species", prop=0)
colnames(dada2_seed_Species)[-ncol(dada2_seed_Species)] <- 
  paste("D_SEED_", colnames(dada2_seed_Species)[-ncol(dada2_seed_Species)], sep="")


m4_Species <- generate_tax_level_table(m4_filt_spec, level="Genus", prop=0)
colnames(m4_Species)[-ncol(m4_Species)] <- 
  paste("M4_", colnames(m4_Species)[-ncol(m4_Species)], sep="")

spec_feat_tabs <- list(parathaa_kSGB_Species, parathaa_seed_Species, dada2_full_Species, dada2_seed_Species,
                       m4_Species)


```

Hmph they still seperate completely here... not the greatest result :/
### Bray
```{r}
Spec_PCA_bray <- generate_PCA(spec_feat_tabs[c(5,1)])
Spec_PCA_bray
```

Still no overlap... but we need to figure out how to deal with multi-assignments when calculating these results..

```{r}
Genus_PCA_bray <- generate_PCA(genus_test)
Genus_PCA_bray
```

### Jaccard
```{r}
Spec_PCA_Jac <- generate_PCA(spec_feat_tabs[c(5,1)], distance="jaccard")
Spec_PCA_Jac
```


# Deep Dive

## Firmciutes/Tenericutes classifications..

```{r}
sub_df_kSGB <- parathaa_ksgb_assignments[which(parathaa_ksgb_assignments$Phylum=="Firmicutes;Tenericutes"),]


merged_data <- sub_df_kSGB %>% left_join(parathaa_seed_assignments, by="query.name")
merged_data$Class.y

#Seed puts them all as Firmicutes

merged_data$Genus.y
#none are classified at Genus level in this case.

merged_data$Family.y
merged_data$Order.y
merged_data$Class.y
#they all get placed in the family Bacillaceae...

dada2_merge <- sub_df_kSGB %>% left_join(DADA2_assignments, by="query.name")
dada2_merge$Phylum.y
dada2_merge$Family.y
dada2_merge$Order.y
dada2_merge$Class.y
#dada2 and seed do not agree
#one puts it in Erysipelotrichales the other puts it in Bacillales...

#hmmm lets try and blast a few...

```

Seems like seed could possibly be putting these in the wrong order...

### 007c28b2f1e870949c3f139a543b27f4

Blast puts it as the result dada2 is giving... (Erysipelotrichaceae)

```{r}
load("~/Repos/Parathaa2_OP3/m4_kSGB_V3V4/resultTree_bestThresholds.RData")

kSGB_tree <- resultData$tax_bestcuts

kSGB_tree$Family[grep("Erysi", kSGB_tree$Family)]
## okay this family does exist in the kSGB tree...

load("~/Repos/Parathaa2_OP3/SILVA_run_V3V4/resultTree_bestThresholds.RData")
Seed_tree <- resultData$tax_bestcuts

Seed_tree$Family[grep("Erysi", Seed_tree$Family)]
# exists in SEED database as well.... okay
```

Has multiple best placements...
(is this what is causing the issue?)

```{r}
kSGB_placements <- read.jplace("~/Repos/Parathaa2_OP3/m4_kSGB_V3V4/Fiber/merged_sub.jplace")

Seed_placements <- read.jplace("~/Repos/Parathaa2_OP3/SILVA_run_V3V4/Fiber/merged_sub.jplace")

ksgb_placement_plot <- plot_placement(kSGB_tree, "Phylum", kSGB_placements, label="007c28b2f1e870949c3f139a543b27f4", collapse = F)

## okay in this case they are placed at tips with 0 branch length
## placed at a pendent length of 0.09 which should land it in atleast genus level..
ksgb_placement_plot[[1]]
```

### 060121fa95de9cd310a3770300fdbce2

```{r}
ksgb_placement_lot <- plot_placement(kSGB_tree, "Phylum", kSGB_placements, 
                                     label="060121fa95de9cd310a3770300fdbce2", collapse=F)
ksgb_placement_lot[[1]]
```

### 131fd919bcc6b3e1722b47979881ad2d

```{r}
ksgb_placement_plot3 <- plot_placement(kSGB_tree, "Phylum", kSGB_placements, 
                                       label="131fd919bcc6b3e1722b47979881ad2d", collapse=F)
ksgb_placement_plot3[[1]]
```

### 15e2285f64a1ddea4ab18f37c692c5b2

```{r}
ksgb_placement_plot4 <- plot_placement(kSGB_tree, "Phylum", kSGB_placements, 
                                       label="15e2285f64a1ddea4ab18f37c692c5b2", collapse=F)
ksgb_placement_plot4[[1]]
```

It seems all of these sequences are placed on this high up internal node in the tree....
It does seem a bit odd there there are a mix of tenericutes and Firmicutes in this close proximity...
Hmm..

### inspection of node
```{r}
get_n_parents(kSGB_tree, 23444, steps = 6)

plot_data <- get_subtree_plot_data(tree=kSGB_tree, node=22974, highlight_lab = "0.992")

#ggplotly(ggtree(as.phylo(plot_data)))
ggtree(as.phylo(plot_data)) %<+% plot_data + geom_tippoint(aes(fill=Phylum, size=highlight, color=highlight), shape=21) + scale_color_viridis_d()


tenericutes_pulled <- plot_data[which(plot_data$Phylum=="Tenericutes"),]
write.table(gsub("\\|.*", "", tenericutes_pulled$label[1:30]), "~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/Tenerciutes_inspection_labels.tsv",
            row.names = FALSE, col.names = FALSE, quote=FALSE, sep="\t")


write.table(merged_data$query.name, "~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/Tenericutes_inspection.tsv",
            row.names=FALSE, col.names=FALSE, quote=FALSE, sep="\t")
```




So it seems that Tenericutes does not exist as a phylum in SILVA or GTDB and is instead part of the Firmicutes Phylum....


Add qiime2 naive bayes gg2 and silva classifications to my comparison as well?
Seems like SEED doesn't do that well either which is very concerning but this could potentially be improved using a bigger database...


