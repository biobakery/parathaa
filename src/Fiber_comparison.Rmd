---
title: "Fiber_Comparison"
author: "Jacob T. Nearing Ph.D."
date: "2023-09-14"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(vegan)
library(stringr)
library(ggvenn)
library(kableExtra)
library(ggplot2)
library(reshape2)
library(cowplot)
library(vegan)
library(treeio)
library(plotly)

source("~/Repos/parathaa/parathaa/src/Diagnositc_functions.R")
```

Load in ParathaakSGB_table
```{r}
parathaa_ksgb_assignments <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/taxonomic_assignments_kSGB.tsv", header=T, sep="\t")

parathaa_abundance_table <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/feature-table.tsv", header=T, sep="\t", skip=1, quote="", comment.char="")

colnames(parathaa_abundance_table)[1] <- "query.name"

parathaa_abundance_table[,-1] <- sweep(parathaa_abundance_table[,-1], 2, colSums(parathaa_abundance_table[,-1]), '/')*100

parathaa_abundance_table_kSGB <- full_join(parathaa_ksgb_assignments, parathaa_abundance_table, by="query.name")

#remove control samples
parathaa_abundance_table_kSGB <- parathaa_abundance_table_kSGB[,-c(256:263, 10)]
```

Load in MetaPhlAn4 table
```{r}
m4_assignments <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/metaphlan_taxonomic_profiles.tsv", sep="\t", quote="", comment.char = "", header=T)

colnames(m4_assignments) <- gsub("_.*", "", colnames(m4_assignments))

indexs <- match(colnames(parathaa_abundance_table), colnames(m4_assignments))
##ignore NAs for the moment..

indexs <- indexs[!is.na(indexs)]


m4_filt <- m4_assignments[,c(1,indexs)]
m4_filt <- m4_filt[-which(rowSums(m4_filt[,-1])==0),]

spec_index <- grep("s__", m4_filt$X..taxonomy)

SGB_index <- grep("t__", m4_filt$X..taxonomy)
only_spec <- setdiff(spec_index, SGB_index)


m4_filt$Species <- gsub(".*s__", "", m4_filt$X..taxonomy)
m4_filt$Species <- gsub("\\|.*", "", m4_filt$Species)

m4_filt$Genus <- gsub(".*g__", "", m4_filt$X..taxonomy)
m4_filt$Genus <- gsub("\\|.*", "", m4_filt$Genus)

m4_filt$Family <- gsub(".*f__", "", m4_filt$X..taxonomy)
m4_filt$Family <- gsub("\\|.*", "", m4_filt$Family)

m4_filt$Order <- gsub(".*o__", "", m4_filt$X..taxonomy)
m4_filt$Order <- gsub("\\|.*", "", m4_filt$Order)

m4_filt$Class <- gsub(".*c__", "", m4_filt$X..taxonomy)
m4_filt$Class <- gsub("\\|.*", "", m4_filt$Class)

m4_filt$Phylum <- gsub(".*p__", "", m4_filt$X..taxonomy)
m4_filt$Phylum <- gsub("\\|.*", "", m4_filt$Phylum)

m4_filt_spec <- m4_filt[c(3,only_spec),]
```

Load in Parathaa_SILVA.SEED
```{r}
parathaa_seed_assignments <- read.table("~/Repos/Parathaa2_OP3/SILVA_run_V3V4/Fiber_assignments/taxonomic_assignments.tsv", header=T, sep="\t")

parathaa_abundance_table_seed <- full_join(parathaa_seed_assignments, parathaa_abundance_table, by="query.name")

parathaa_abundance_table_seed <- parathaa_abundance_table_seed[,-c(1, 256:263)]
```

Load in Dada2 assignments
```{r}
DADA2_assignments <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/dada2_assignments.tsv", sep="\t", header=T)
colnames(DADA2_assignments)[8] <- "query.name"

dada2_abundance_table <- full_join(DADA2_assignments, parathaa_abundance_table, by="query.name")
dada2_abundance_table <- dada2_abundance_table[,-c(1, 256:263)]
```

Load in Dada2 seed assignments
```{r}
DADA2_assignments_seed <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/dada2_assignments_seed.tsv", sep="\t", header=T)

colnames(DADA2_assignments_seed)[8] <- "query.name"
dada2_seed_abundance_table <- full_join(DADA2_assignments_seed, parathaa_abundance_table, by="query.name")
dada2_seed_abundance_table <- dada2_seed_abundance_table[,-c(1,256:263)]
```

Load in Parathaa_OG_pipe
```{r}
Parathaa_assignments_OG <- read.table("~/Repos/Parathaa2_OP3/Datasets/fiber_amplicons_true/taxonomic_assignments/taxonomic_assignments.tsv", sep="\t", header=T)

parathaa_abundance_table_OG <- full_join(Parathaa_assignments_OG, parathaa_abundance_table, by="query.name")

parathaa_abundance_table_OG <- parathaa_abundance_table_OG[,-c(1, 256:263)]

```


# Number of assignments {.tabset}

Functions
```{r}
tax_levels <- c("Species", "Genus", "Family", "Order", "Class", "Phylum")
calculate_assignments <- function(tax_assignments){
  
  ret_frame <- data.frame(matrix(nrow=12, ncol=1))
  multi_names <- paste("multi", tax_levels, sep=" ")
  rownames(ret_frame) <- c(tax_levels, multi_names)
  colnames(ret_frame) <- "Number of Assignments"  
  
  
  for(i in 1:length(tax_levels)){
    ret_frame[tax_levels[i],1] <- length(which(!is.na(tax_assignments[,tax_levels[i]])))
    ret_frame[multi_names[i],1] <- length(which(grepl(";", tax_assignments[,tax_levels[i]])))
  }
  return(ret_frame)
}
```

## Parathaa kSGB
```{r}
Assignment_levels_kSGB <- calculate_assignments(parathaa_ksgb_assignments)
kable_styling(kable((Assignment_levels_kSGB)))
```

## Parathaa SEED
```{r}
Assignment_levels_SEED <- calculate_assignments(parathaa_seed_assignments)
kable_styling(kable(Assignment_levels_SEED))
```

## Parathaa OG
```{r}
Assignment_levels_OG <- calculate_assignments(Parathaa_assignments_OG)
kable_styling(kable(Assignment_levels_OG))
```

## Dada2
```{r}
Assignment_levels_DADA2 <- calculate_assignments(DADA2_assignments)
kable_styling(kable(Assignment_levels_DADA2))
```

## Dada2_seed
```{r}
Assignment_levels_DADA2_seed <- calculate_assignments(DADA2_assignments_seed)
kable_styling(kable(Assignment_levels_DADA2_seed))
```

Yikes these are a bit concerning...

## Combined table
```{r}
colnames(Assignment_levels_kSGB) <- "# of Assign. kSGB"
colnames(Assignment_levels_SEED) <- "# of Assign. SEED"
colnames(Assignment_levels_DADA2) <- "# of Assign. DADA2"
colnames(Assignment_levels_DADA2_seed) <- "# of Assign. DADA2.Seed"
colnames(Assignment_levels_OG) <- "# of Assign. OG"

merged_assignments <- cbind(Assignment_levels_kSGB, Assignment_levels_SEED, 
                            Assignment_levels_OG, Assignment_levels_DADA2,
                            Assignment_levels_DADA2_seed)
kable_styling(kable(merged_assignments))
```

# Composition Analysis

```{r}
generate_tax_level_table <- function(table, level, prop=1){
  res_list <- list()
  Other <- c()
  for(i in unique(table[,level])){
    tmp_df <- table[which(table[,level]==i),]
    tmp_df <- tmp_df %>% select_if(is.numeric)
    
    tmp <- colSums(tmp_df)
    if(mean(tmp) < prop){
      if(length(Other)==0){
        Other <- tmp
      }else{
      Other <- Other + tmp 
      }
    }else
      res_list[[i]] <- tmp
  }
  res_list[["Other"]] <- Other
  res_df <- data.frame(do.call(rbind, res_list))
  if("maxDist" %in% colnames(res_df)){
      res_df <- res_df[,-which(colnames(res_df) == "maxDist")]
  }
  res_df$Taxon <- rownames(res_df)
  return(res_df)
}
```

## Phylum {.tabset}
```{r}
parathaa_kSGB_Phylum <- generate_tax_level_table(parathaa_abundance_table_kSGB, "Phylum")
parathaa_seed_Phylum <- generate_tax_level_table(parathaa_abundance_table_seed, "Phylum")
parathaa_OG_Phylum <- generate_tax_level_table(parathaa_abundance_table_OG, "Phylum")

dada2_full_Phylum <- generate_tax_level_table(dada2_abundance_table, "Phylum")
dada2_seed_Phylum <- generate_tax_level_table(dada2_seed_abundance_table, "Phylum")

m4_Phylum <- generate_tax_level_table(m4_filt_spec, "Phylum")

unique(c(parathaa_kSGB_Phylum$Taxon, parathaa_seed_Phylum$Taxon, dada2_full_Phylum$Taxon,
       dada2_seed_Phylum$Taxon, m4_Phylum$Taxon, parathaa_OG_Phylum$Taxon))

parathaa_kSGB_Phylum_melt <- melt(parathaa_kSGB_Phylum)
parathaa_seed_Phylum_melt <- melt(parathaa_seed_Phylum)
dada2_full_Phylum_melt <- melt(dada2_full_Phylum)
dada2_seed_Phylum_melt <- melt(dada2_seed_Phylum)
parathaa_OG_Phylum_melt <- melt(parathaa_OG_Phylum)

m4_Phylum_melt <- melt(m4_Phylum)

Phyla_colors <- c('Actinobacteria'="#c56445", "Bacteroidetes"="#9764c9", 'Firmicutes'="#aca535", 
                  'Other'="#6d96ca", "Proteobacteria"="#659f60", "UNCLASSIFIED"="#c65c8a",
                  'Actinobacteriota'="#c56445", 'Bacteroidota'="#9764c9", "Fusobacteriota"="cyan")
```

### Parathaa kSGB
```{r}
parathaa_kSGB_phyla_plot <- parathaa_kSGB_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

parathaa_kSGB_phyla_plot
```

### Parathaa SEED
```{r}
parathaa_seed_phyla_plot <- parathaa_seed_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

parathaa_seed_phyla_plot
```

### Parathaa OG
```{r}
parathaa_OG_phyla_plot <- parathaa_OG_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

parathaa_OG_phyla_plot
```

### Dada2 Full
```{r}
dada2_full_phyla_plot <- dada2_full_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

dada2_full_phyla_plot
```

### Dada2 SEED
```{r}
dada2_seed_phyla_plot <- dada2_seed_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

dada2_seed_phyla_plot
```

### MetaPhlAn4
```{r}
m4_Phyla_plot <- m4_Phylum_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Phyla_colors)

m4_Phyla_plot
```

### Combined
```{r}
plot_grid(parathaa_kSGB_phyla_plot +xlab("Parathaa_kSGB") + ylab(""),
          parathaa_seed_phyla_plot + xlab("Parathaa_SEED") + ylab(""),
          parathaa_OG_phyla_plot + xlab("Parathaa_OG") + ylab(""),
          dada2_full_phyla_plot + xlab("DADA2_full") + ylab(""),
          dada2_seed_phyla_plot + xlab("DADA2_SEED") +ylab(""),
          m4_Phyla_plot + xlab("MetaPhlAn4") + ylab(""),
          ncol=1)
```

## Genus Comparison
```{r}
parathaa_kSGB_Genus <- generate_tax_level_table(parathaa_abundance_table_kSGB, "Genus", prop=5)
parathaa_seed_Genus <- generate_tax_level_table(parathaa_abundance_table_seed, "Genus", prop=5)
parathaa_OG_Genus <- generate_tax_level_table(parathaa_abundance_table_OG, "Genus", prop=5)

dada2_full_Genus <- generate_tax_level_table(dada2_abundance_table, "Genus", prop=5)
dada2_seed_Genus <- generate_tax_level_table(dada2_seed_abundance_table, "Genus", prop=5)

m4_genus <- generate_tax_level_table(m4_filt_spec, "Genus", prop=5)

unique(c(parathaa_kSGB_Genus$Taxon, parathaa_seed_Genus$Taxon, dada2_full_Genus$Taxon, dada2_seed_Genus$Taxon, m4_genus$Taxon))

parathaa_kSGB_Genus_melt <- melt(parathaa_kSGB_Genus)
parathaa_seed_Genus_melt <- melt(parathaa_seed_Genus)
parathaa_OG_Genus_melt <- melt(parathaa_OG_Genus)

dada2_full_Genus_melt <- melt(dada2_full_Genus)
dada2_seed_Genus_melt <- melt(dada2_seed_Genus)

m4_genus_melt <- melt(m4_genus)

Genera_colors_5 <- c("Desulfofarcimen"="#a2b148",
                     "Firmicutes_unclassified"="#a756c3",
                     "Other"="grey",
                     "Bacillus"="#5bb94e",
                     "Clavibacter"="#6b6dc6",
                     "Peptoclostridium"="#d39a3b",
                     "Turicibacter"="#6999d4",
                     "Romboutsia"="#ca542a",
                     "Blautia"="#54c0a9",
                     "Bifidobacterium"="#d3425f",
                     "GGB51725"="#49874d",
                     "GGB47957"="#da73b6",
                     "GGB77090"="#83732f",
                     "GGB77090"="#a34d72",
                     "Collinsella"="#cc7d62")

```

### Parathaa kSGB
```{r}
parathaa_kSGB_genus_plot <- parathaa_kSGB_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

parathaa_kSGB_genus_plot
```

### Parathaa SEED
```{r}
parathaa_seed_genus_plot <- parathaa_seed_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

parathaa_seed_genus_plot
```

### Parathaa OG
```{r}
parathaa_OG_genus_plot <- parathaa_OG_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

parathaa_OG_genus_plot
```

### dada2 full
```{r}
dada2_full_Genus_plot <- dada2_full_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

dada2_full_Genus_plot
```

### dada2 SEED
```{r}
dada2_seed_genus_plot <- dada2_seed_Genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

dada2_seed_genus_plot
```

### MetaPhlAn4

```{r}
m4_genus_plot <- m4_genus_melt %>% 
  ggplot(aes(x=variable, y=value, fill=Taxon)) + geom_col()+
  theme_classic(base_size = 16) + theme(axis.text.x = element_blank()) +
  xlab("") + ylab("Relative Abundance") +
  scale_fill_manual(values=Genera_colors_5)

m4_genus_plot
```


### Combined
```{r}
plot_grid(parathaa_kSGB_genus_plot + ylab("") + xlab("Parathaa kSGB"),
          parathaa_seed_genus_plot + ylab("") + xlab("Parathaa SEED"),
          parathaa_OG_genus_plot + ylab("") + xlab("Parathaa OG"),
          dada2_full_Genus_plot + ylab("") + xlab("Dada2 Full"),
          dada2_seed_genus_plot + ylab("") + xlab("Dada2 Seed"),
          m4_genus_plot + ylab("") + xlab("MetaPhlAn4"),
          ncol=1)
```


## PCA Analysis

```{r}
#takes in a list of feature tables
#takes in a distance type
#generates PCA 
#its not the perfect analysis since B/C doesn't do well with multi-assignments..

generate_PCA <- function(feat_tables, distance="bray"){
  merged_data <- Reduce(function(x, y) merge(x, y, by="Taxon", all=T), feat_tables)
  rownames(merged_data) <- merged_data$Taxon
  merged_data <- merged_data[,-1]
  merged_data[is.na(merged_data)] <- 0
  
  merged_data <- data.frame(t(merged_data))
  
  merged_dist <- vegdist(merged_data, method=distance)
  merged_PCA <- cmdscale(merged_dist, k=2, eig=T)
  
  plot_df <- data.frame(sample=rownames(merged_PCA$points),
                      PC1=merged_PCA$points[,1],
                      PC2=merged_PCA$points[,2])
  plot_df <- plot_df %>% mutate(Method = case_when(
    grepl("P_kSGB_", sample) ~ 'Parathaa_kSGB',
    grepl("P_SEED_", sample) ~ 'Parathaa_SEED',
    grepl("D_Full_", sample) ~ 'Dada2_Full',
    grepl("D_SEED_", sample) ~ 'Dada2_SEED',
    grepl("M4_", sample) ~ 'MetaPhlAn4'
  ))
  
  ret_plot <- plot_df %>% ggplot(aes(x=PC1, y=PC2, colour=Method)) + geom_point() +
    theme_classic(base_size=16)
  return(ret_plot)
}
```

Generate data
```{r}
parathaa_kSGB_Species <- generate_tax_level_table(parathaa_abundance_table_kSGB, level="Species", prop=0)
colnames(parathaa_kSGB_Species)[-ncol(parathaa_kSGB_Species)] <- 
  paste("P_kSGB_", colnames(parathaa_kSGB_Species)[-ncol(parathaa_kSGB_Species)], sep="")

parathaa_seed_Species <- generate_tax_level_table(parathaa_abundance_table_seed, level="Species", prop=0)
colnames(parathaa_seed_Species)[-ncol(parathaa_seed_Species)] <- 
  paste("P_SEED_", colnames(parathaa_seed_Species)[-ncol(parathaa_seed_Species)], sep="")


dada2_full_Species <- generate_tax_level_table(dada2_abundance_table, level="Species", prop=0)
colnames(dada2_full_Species)[-ncol(dada2_full_Species)] <- 
  paste("D_Full_", colnames(dada2_full_Species)[-ncol(dada2_full_Species)], sep="")

dada2_seed_Species <- generate_tax_level_table(dada2_seed_abundance_table, level="Species", prop=0)
colnames(dada2_seed_Species)[-ncol(dada2_seed_Species)] <- 
  paste("D_SEED_", colnames(dada2_seed_Species)[-ncol(dada2_seed_Species)], sep="")


m4_Species <- generate_tax_level_table(m4_filt_spec, level="Species", prop=0)
colnames(m4_Species)[-ncol(m4_Species)] <- 
  paste("M4_", colnames(m4_Species)[-ncol(m4_Species)], sep="")

spec_feat_tabs <- list(parathaa_kSGB_Species, parathaa_seed_Species, dada2_full_Species, dada2_seed_Species,
                       m4_Species)



```

### Bray
```{r}
Spec_PCA_bray <- generate_PCA(spec_feat_tabs)
Spec_PCA_bray
```

### Jaccard
```{r}
Spec_PCA_Jac <- generate_PCA(spec_feat_tabs, distance="jaccard")
Spec_PCA_Jac
```

# Deeper investigation

```{r}
region_tree_kSGB <- "~/Repos/Parathaa2_OP3/M4_Oct22/M4_kSGB_V3V4/region_specific.tree"
taxafile_kSGB <- "~/Repos/Parathaa2_OP3/M4_Oct22/taxmapper.tsv"
load("~/Repos/Parathaa2_OP3/M4_Oct22/M4_kSGB_V3V4/resultTree_bestThresholds.RData")
Parathaa_kSGB_tree <- resultData$tax_bestcuts
Parathaa_kSGB_placements <- read.jplace("~/Repos/Parathaa2_OP3/M4_Oct22/M4_kSGB_V3V4/Fiber_assignments/merged_sub.jplace")


region_tree_SEED <- "~/Repos/Parathaa2_OP3/SILVA_run_V3V4/region_specific.tree"
taxafile_SEED <- "~/Repos/Parathaa/parathaa/input/silva_v138/taxmap_slv_ssu_ref_138.1.txt"

load("~/Repos/Parathaa2_OP3/SILVA_run_V3V4/resultTree_bestThresholds.RData")
Parathaa_SEED_tree <- resultData$tax_bestcuts
Parathaa_SEED_placements <- read.jplace("~/Repos/Parathaa2_OP3/SILVA_run_V3V4/Fiber_assignments/merged_sub.jplace")
```

## Phylum investigation...
```{r}
merged_parathaa_assignments <- full_join(parathaa_ksgb_assignments, parathaa_seed_assignments, by="query.name")

phylum_non_agreement <- merged_parathaa_assignments[which(merged_parathaa_assignments$Phylum.x !=
                                                            merged_parathaa_assignments$Phylum.y),]

setdiff(phylum_non_agreement$Phylum.x, phylum_non_agreement$Phylum.y)
setdiff(phylum_non_agreement$Phylum.y, phylum_non_agreement$Phylum.x)

phylum_non_agreement$Phylum.y[which(phylum_non_agreement$Phylum.y=="Actinobacteriota")] <- "Actinobacteria"
phylum_non_agreement$Phylum.y[which(phylum_non_agreement$Phylum.y=="Bacteroidota")] <- "Bacteroidetes"
phylum_non_agreement$Phylum.y[which(phylum_non_agreement$Phylum.y=="Acidobacteriota")] <- "Acidobacteria"
phylum_non_agreement$Phylum.y[which(phylum_non_agreement$Phylum.y=="Fusobacteriota")] <- "Fusobacteria"

phylum_non_agreement <- phylum_non_agreement[which(phylum_non_agreement$Phylum.x !=
                                                     phylum_non_agreement$Phylum.y),]
```

### Bacterodietes dive... {.tabset}

```{r}
non_agree_bacts <- phylum_non_agreement[which(phylum_non_agreement$Phylum.x=="Bacteroidetes"),]
non_agree_bacts$query.name[1]
non_agree_bacts$query.name[2]
```

#### 008424a175a5cc75c61aa1a547a93f2b

```{r}
non_agree_bacts[which(non_agree_bacts$query.name=="008424a175a5cc75c61aa1a547a93f2b"),]
DADA2_assignments[which(DADA2_assignments$query.name=="008424a175a5cc75c61aa1a547a93f2b"),]
```
HMMM so dada2 assigns it Fusobacterium but the other two do not... that is very concerning...

All blast searches give: Fusobacterium..

Lets look at the tree placements...
```{r}
parthaa_kSGB_placements <- get.placements(Parathaa_kSGB_placements)

### hmmm I think something is going wrong here...
parthaa_kSGB_placement_nodes <- plot_placement(Parathaa_kSGB_tree, "Phylum", Parathaa_kSGB_placements, 
                                         label="008424a175a5cc75c61aa1a547a93f2b")

get_n_parents(Parathaa_kSGB_tree, 2320, 10)

subtree_parent <- get_subtree_plot_data(Parathaa_kSGB_tree, 13294, isTip=FALSE,
                                        highlight_lab = "PEMPGKGO_00004_16S_ribosomal_RNA|M1878371282")

ggtree(as.phylo(subtree_parent)) %<+% subtree_parent + geom_tippoint(aes(fill=Phylum, size=highlight, color=highlight), shape=21)
```
It seems the placements around it are all "bacteroidetes" lets blast the sequence at its tip..

It does blast to Bacteroidetes... so doesn't seem like a huge issue... 

Why is it being placed there though?????
Something is clearly going wrong here during placement not sure what it is though...
Is it the bifurcation enforcement?





```{r}
parthaa_SEED_placement <- plot_placement(Parathaa_SEED_tree, "Phylum", Parathaa_SEED_placements,
                                         label="008424a175a5cc75c61aa1a547a93f2b")
parthaa_SEED_placement

get_n_parents(Parathaa_SEED_tree, 2030, 10)

subtree_parent_SEED <- get_subtree_plot_data(Parathaa_SEED_tree, 5918, isTip = FALSE,
                                             highlight_lab="AF030451.Ru2Albu9")

ggtree(as.phylo(subtree_parent_SEED)) %<+% subtree_parent_SEED + geom_tippoint(aes(fill=Phylum, size=highlight, color=highlight), shape=21) + scale_color_viridis_d()
```

HMMM it places it in the Firmicutes...
There are Fuso's in the subtree but there are a bit far away...

Again looks like it is a placement issue?



#### 00fd4ac0447c6b6539db1bcc40240e81
```{r}
non_agree_bacts[which(non_agree_bacts$query.name=="00fd4ac0447c6b6539db1bcc40240e81"),]
DADA2_assignments[which(DADA2_assignments$query.name=="00fd4ac0447c6b6539db1bcc40240e81"),]
```

So parathaa_kSGB says it should be Bacteroidetes... (no classification after Phylum...)
Parathaa_SEED says it should be Actinobacteria...(Order is Streptosporangiales...)
DADA2 says it should be Actinobacteria... (Family is Eggerthellaceae, Genus is Asaccharobacter...)

So DADA2 and Parathaa do not agree on Order assignment... lets dig in...

BLAST says: it should be in Eggerthellaceae.... 

```{r}
### hmmm I think something is going wrong here...
parthaa_kSGB_placement_nodes <- plot_placement(Parathaa_kSGB_tree, "Phylum", Parathaa_kSGB_placements, 
                                         label="00fd4ac0447c6b6539db1bcc40240e81")
parthaa_kSGB_placement_nodes

get_n_parents(Parathaa_kSGB_tree, 2456, 10)

subtree_parent <- get_subtree_plot_data(Parathaa_kSGB_tree, 13287, isTip=FALSE,
                                        highlight_lab = "MDNOLOHA_04242_16S_ribosomal_RNA|M1873143409")

ggtree(as.phylo(subtree_parent)) %<+% subtree_parent + geom_tippoint(aes(fill=Phylum, size=highlight, color=highlight), shape=21)
```

Bad placement??

```{r}
parthaa_SEED_placement_nodes <- plot_placement(Parathaa_SEED_tree, "Phylum", Parathaa_SEED_placements,
                                               label="00fd4ac0447c6b6539db1bcc40240e81")

## placed at a bifurcated branch so it won't plot...
#parthaa_SEED_placement_nodes

get_n_parents(Parathaa_SEED_tree, 2692, 10)

subtree_parent <- get_subtree_plot_data(Parathaa_SEED_tree, 6920, isTip=FALSE,
                                        highlight_lab = c("AF116563.GWJChro2", "AB011817.I97Lent5"),
                                        level="Family")

get_mrca_of_set(as.phylo(Parathaa_SEED_tree), c(2717, 2692))

ggtree(as.phylo(subtree_parent)) %<+% subtree_parent + geom_tippoint(aes(fill=Phylum, size=highlight, color=highlight), shape=21) + scale_color_viridis_d()
```

This placement looks fine at genus level but is pretty far away from Eggerthelleace at the family level (which is its most likely origin given the dada2 and blast search)
